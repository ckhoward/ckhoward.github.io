<!DOCTYPE html>
<html lang="en-US">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="Chris Howard Portfolio">

<base href="https://ckhoward.github.io/">
<title>


     Chris Howard - Deploying a Tor Hidden Service with DigitalOcean 

</title>
<link rel="canonical" href="https://ckhoward.github.io/blog/deploying-a-tor-hidden-service-with-digitalocean/">


<script type="text/javascript">
    var baseURL = 'https:\/\/ckhoward.github.io\/';
    var host = baseURL.substring(0, baseURL.length - 1).replace(/\//g, '');
    if ((host === window.location.host) && (window.location.protocol !== 'https:')) {
        window.location.protocol = 'https:';
    }
</script>




  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/styles/default.min.css">


<link rel="stylesheet" href="https://ckhoward.github.io/css/reset.css">
<link rel="stylesheet" href="https://ckhoward.github.io/css/pygments.css">
<link rel="stylesheet" href="https://ckhoward.github.io/css/main.css">




<link rel="shortcut icon"

    href="https://ckhoward.github.io/img/datcactus.png"

>






</head>


<body lang="en">



</section>
<section class="header"> 

    <div class="container">
        <a href="https://ckhoward.github.io/"><img class="logo" src="https://ckhoward.github.io/img/datcactus.png" /></a>
        <div class="content">
            <a href="https://ckhoward.github.io/"><div class="name"><h1>Chris Howard</h1></div></a>
            <nav>
                <ul>
                    <a href="https://ckhoward.github.io/"><li>Blog</li></a>
                    <a href="https://ckhoward.github.io/about/"><li>About</li></a>
                    <a href="https://ckhoward.github.io/projects/"><li>Projects</li></a>
                </ul>
            </nav>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">

        
            <a href="https://github.com/ckhoward" target="_blank">
                <i class="icon ion-social-github"></i>
            </a>
        
        
        
            <a href="https://twitter.com/_ckhoward" target="_blank">
                <i class="icon ion-social-twitter"></i>
            </a>
        

        
            <a href="https://www.linkedin.com/in/-ckhoward/" target="_blank">
                <i class="icon ion-social-linkedin"></i>
            </a>
        

        
            <a href="mailto:ck_howard@yahoo.com">
                <i class="icon ion-ios-email larger"></i>
            </a>
        

        
            <a href="https://ckhoward.github.io/index.xml">
                <i class="icon ion-social-rss larger"></i>
            </a>
        
        </div>
    </div>
</section>


<section class="main post non-narrow zero-top-spacing">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    Deploying a Tor Hidden Service with DigitalOcean

</div>

                    <div class="initials"><a href="https://ckhoward.github.io/"></a></div>
                </div>
                <div class="meta">
                    <div class="date" title="Fri Dec 29 2017 00:00:00 UTC">Dec 29, 2017</div>
                    <div class="reading-time"><div class="middot"></div>6 minutes read</div>
                </div>
            </div>
            <div class="markdown">
                

<h1 id="deploying-a-tor-hidden-service-with-digitalocean">Deploying a Tor Hidden Service with DigitalOcean</h1>

<h4 id="a-quick-primer-on-tor-hidden-services">A quick primer on Tor hidden services</h4>

<p>The Tor protocol picks 3 onion routers at random, builds <em>circuits</em> to them, treating them as introduction (or contact) points; since this is a circuit, there is no direct connection, so no IP addresses are shared, just public keys. These public keys work toward &ldquo;shaking hands&rdquo; at a rendezvous point. If the handshake happens, the rendezvous point connects Alice&rsquo;s and Bob&rsquo;s circuits, and then they can communicate anonymously. While the protocol isn&rsquo;t without flaw, it is still powerful, especially when used in conjunction with other practices and tools. If you have sensitive information, it is your responsibility to ensure that your system is protected, and that your visitors are protected. Deploying a hidden service is a good step toward offering that protection.</p>

<h2 id="deploy-the-vps-with-digital-ocean">Deploy the VPS with Digital Ocean</h2>

<p>We are going to create a Debian Droplet on DigitalOcean. After creating my account, I fork up the $5 to create my Droplet—it would be cool if DigitalOcean gave a student discount for students to practice, but I digress.</p>

<p><img src="img/vps_install_1.jpg" alt="VPS Install" title="VPS Install" /></p>

<p>I chose not to add an SSH key, and I left the hostname at its default. If you are comfortable with SSH, feel free to add yours, but this tutorial assumes a lack of familiarity. Click that giant green <strong>Create</strong> button and the droplet should be created within the minute.</p>

<h3 id="set-up-ssh-for-securely-logging-in">Set Up SSH for Securely Logging In</h3>

<p>DigitalOcean has a solid tutorial on first steps for <a href="https://www.digitalocean.com/community/tutorials/how-to-configure-ssh-key-based-authentication-on-a-linux-server">setting up SSH</a>.</p>

<p>I generate a key and since I already have a (useless) key named id_rsa, I choose to overwrite it. I hit enter twice to get through the passphrase prompts. The key is generated (and some parts blanked out by me)—this generated randomart is supposed to make it easier for the user to verify that the key hasn&rsquo;t been tampered with, otherwise they would have to compare long strings of text.</p>

<p>Because we created the droplet without an SSH key, DigitalOcean sent us an email with our username (likely root), droplet IP, and temporary password. I personally logged into the console through the DigitalOcean web-portal and changed my password to something else, but that isn&rsquo;t necessary.</p>

<p>To copy your public key to your server Use <code>ssh-copy-id username@ip</code>. Note, your username will be root by default, counterintuitively. Use either the temporary password that was emailed to you, or your updated password if you went that route. Now you should be able to SSH into your server with <code>ssh username@ip</code>.</p>

<p>After successfully SSHing into your server, consider disabling password authentication on your server to prevent brute-force attacks. In the linked tutorial, at the bottom, under <strong>Disabling Password Authentication on your Server:</strong></p>

<ul>
<li><code>sudo nano /etc/ssh/sshd_config</code></li>
<li>Change from <code>PasswordAuthentication yes</code> to <code>PasswordAuthentication no</code></li>
<li><code>sudo service ssh restart</code></li>
</ul>

<p><img src="img/ufw5.jpg" alt="Password Authentication" title="Password Authentication Off" /></p>

<p>Now the only way to get into your server is SSH.</p>

<h3 id="install-the-uncomplicated-firewall">Install the Uncomplicated Firewall</h3>

<p>ufw is a frontend for iptables, which is a firewall system for Linux, but simpler. ufw will be installed to at least reduce the number of attacks your server might get, as we are going to block most traffic. Chances of attack are pretty high, you can install <a href="https://www.fail2ban.org/wiki/index.php/Main_Page">Fail2Ban</a> to scan and ban IP addresses associated with malicious activity (most of which will probably be Chinese). It&rsquo;s better to get security stuff right early on. Also be mindful that Tor relays and exit nodes are also frequently attacked.</p>

<p>Run the following commands in your command line, while logged into your server:</p>

<pre><code>sudo apt-get update
sudo apt-get upgrade -y
sudo apt-get dist-upgrade -y
sudo apt-get install ufw
</code></pre>

<p>Updating first will help you prevent running into this error:</p>

<blockquote>
<p>Package ufw is not available, but is referred to by another package. This may mean that the package is missing, has been obsoleted, or is only available from another source</p>

<p>E: Package &lsquo;ufw&rsquo; has no installation candidate</p>
</blockquote>

<p>and you should be good to go. The firewall is installed. Now enable the firewall:</p>

<pre><code>sudo ufw enable -y
sudo ufw status
</code></pre>

<p>Status <em>should</em> output <strong>Status: active</strong>.</p>

<h3 id="create-a-new-user-account">Create a New User Account</h3>

<p>To be careful not to do something disastrous in the server, it is good practice to create a new, non-root user account, and to limit its privileges so that we reduce the likelihood of breaking something important. Additionally, using an alternative account and getting rid of the root account can also work toward preventing being brute-forced. Again, DigitalOcean has a nice tutorial on <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-16-04">creating a new user</a>.</p>

<pre><code>adduser ckhoward #but enter your own username, of course
usermod -aG sudo ckhoward
ssh-copy-id ckhoward@ip #this works since we already generated the key
su - ckhoward #to switch to other user
chmod 700 ~/.ssh
nano .ssh/authorized_keys #this is where you paste the contents of your id_rsa pub file, cntrl x, y, ENTER
chmod 600 ~/.ssh/authorized_keys
exit
</code></pre>

<p>Of course, test that all of this is working by <code>ssh ckhoward@ip</code>.</p>

<h3 id="install-apache-web-server">Install Apache Web server</h3>

<p>DigitalOcean provides an alternative tutorial on <a href="https://www.digitalocean.com/community/tutorials/how-to-install-the-apache-web-server-on-ubuntu-16-04">installing the apache web server</a>. A command is needed to let the firewall know that apache is okay. This is referred to as a rule. <code>sudo ufw allow from 127.0.0.1 to any port 80</code> You can find your own IP address and only allow that, if you want, while you set up your server. This would have to be altered later on, if you expect others to hop on. If you would like to look at the rules you&rsquo;ve set for allowing and denying connections, <code>sudo ufw status numbered</code> is a handy command. At this point, it should output:</p>

<pre><code>[1] 80 ALLOW IN 127.0.0.1
</code></pre>

<p>In my case, I set a rule for allowing only SSH connections from my IP address.</p>

<p><img src="img/ufw7.jpg" alt="UFW Firewall Rules" title="Firewall Rule" /></p>

<p>Installing apache2 and running it is trivial, enter the following commands:</p>

<pre><code>sudo apt-get update
sudo apt-get install apache2
sudo systemctl start apache2.service
sudo systemctl status apache2
#if apache is running, enter:
hostname -I # this will give you a couple of IPs, enter them into your browser to find your site
</code></pre>

<p>After you&rsquo;ve accessed your site from your browser, your activity should have been logged. You can check this with by finding and printing your logs with <code>tail -f /var/log/apache2/access.log</code>. There will be information associated with the request, the browser used, and the timestamp.</p>

<h3 id="install-tor">Install Tor</h3>

<p>Run the command <code>sudo apt-get install tor</code>. Surprisingly simple. The Tor documentation instructs anyone deploying a hidden service to navigate to the torrc config file and uncomment the two statements:</p>

<blockquote>
<p>#HiddenServiceDir /var/lib/tor/hidden_service/</p>

<p>#HiddenServicePort 80 127.0.0.1:80</p>
</blockquote>

<p>Thus, we find the config file and edit it with the following:</p>

<pre><code>find / -iname &quot;torrc&quot;
sudo nano /etc/tor/torrc
</code></pre>

<p>If the apache2 service is still running, let&rsquo;s just restart that with <code>sudo systemctl restart apache2.service</code>. Start Tor with <code>sudo service tor start</code>. Tor is now running and has an associated Onion address. To find this address, run <code>cat $HOME/hidden_service/hostname</code> and the Onion address will print. This guide has set you up for the basics of getting a hidden service running with DigitalOcean. There are other guides on better practices for <a href="https://riseup.net/en/security/network-security/tor/onionservices-best-practices">securing hidden services</a>.</p>

<p><img src="img/hidden_service.jpg" alt="Hidden Service Result" title="Resulting Onion Site" /></p>

<p><em>Credit goes to <a href="http://u.arizona.edu/~dsidi/">David Sidi</a> for coming up with this idea in the form of a class assignment.</em></p>

                <br>
                <p><a href="https://ckhoward.github.io/">Back to posts</a></p>
            </div>
            <br>
            <div class="disqus">
                
            </div>
        </div>
    </div>
</section>


  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
  

  <script type="text/javascript">
    hljs.initHighlightingOnLoad();
  </script>



</body>
</html>

